<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="erpPartner">
	<!-- start.. 페이징 에 사용할 쿼리들 -->
	
	<select id="selectSearchCount" parameterType="hashmap" resultType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		SELECT
				COUNT(PRTN_SQ) AS PRTN_SQ
		FROM
				TB_EEP_PRTN P
		<where>
			<if test="prtnTypCd != '' and prtnTypCd != null ">
				AND P.PRTN_TYP_CD = #{prtnTypCd}
			</if>		
			<if test="searchOption != '' and searchOption == 'prtnEnrlmNum'">
				AND P.PRTN_ENRLM_NUM LIKE CONCAT('%',#{search},'%')
			</if>
			<if test="searchOption != '' and searchOption == 'prtnNm'">
				AND P.PRTN_NM LIKE CONCAT('%',#{search},'%')
			</if>
		</where>
	</select>
	
	<select id="selectPartnerPagingList" resultType="com.erp.admin.business.partner.vo.ErpPartnerVo" parameterType="hashmap">
		SELECT
			@rownum:=@rownum+1 AS RNUM
			, P.PRTN_SQ
	 		, C.CODE_NM
			, P.PRTN_NM
			, P.PRTN_RPRSN_NM
			, P.PRTN_LOC
			, P.PRTN_ENRLM_NUM
			, M.PRTN_MNGR1_DEPT
			, M.PRTN_MNGR1_RNK
			, M.PRTN_MNGR1_NM
			, M.PRTN_MNGR1_RPRSN_PH
			, M.PRTN_MNGR1_EML
		FROM 
			TB_EEP_PRTN P 
		NATURAL JOIN 
			(SELECT @rownum :=0) R	
		INNER JOIN 
			TB_EST_CODE C 
		ON 
			C.CODE_COM_CD = P.PRTN_TYP_CD
		JOIN 
			TB_EEP_PRTN_MNGR M 
		USING
			(PRTN_ENRLM_NUM)
		<where>
			<if test="prtnTypCd != '' and prtnTypCd != null ">
				AND P.PRTN_TYP_CD = #{prtnTypCd}
			</if>		
			<if test="searchOption != '' and searchOption == 'prtnEnrlmNum'">
				AND P.PRTN_ENRLM_NUM LIKE CONCAT('%',#{search},'%')
			</if>
			<if test="searchOption != '' and searchOption == 'prtnNm'">
				AND P.PRTN_NM LIKE CONCAT('%',#{search},'%')
			</if>
		</where>
		ORDER BY
			P.PRTN_SQ DESC
		LIMIT
			#{limit},10		
	</select>
	
	<!-- 페이징 에 사용할 쿼리들 end..-->


	<!-- 입력받은 협력사 정보 등록. TB_EEP_PRTN 테이블, TB_EEP_PRTN_MNGR 테이블에 삽입. -->
	<insert id="insertPartner" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
	
		INSERT INTO	TB_EEP_PRTN (
					PRTN_TYP_CD
				,	PRTN_ENRLM_NUM
				,	PRTN_NM
				,	PRTN_RPRSN_NM
				,	PRTN_ETB_DT
		<if test="prtnTypCd == 'P00002'">
				,	PRTN_CRPRT_NUM
		</if>
				,	PRTN_LOC
				,	PRTN_BSNSCON
				,	PRTN_SRVC
		)
		VALUES (
					#{prtnTypCd}
				,	#{prtnEnrlmNum}
				,	#{prtnNm}
				,	#{prtnRprsnNm}
				,	#{prtnEtbDt}
		<if test="prtnTypCd == 'P00002'">		
				,	#{prtnCrprtNum}
		</if>		
				,	#{prtnLoc}
				,	#{prtnBsnscon}
				,	#{prtnSrvc}
		);
		INSERT INTO TB_EEP_PRTN_MNGR (
					PRTN_ENRLM_NUM
				,	PRTN_MNGR1_DEPT
				,	PRTN_MNGR1_RNK
				,	PRTN_MNGR1_NM
				,	PRTN_MNGR1_RPRSN_PH
				,	PRTN_MNGR1_PH
				,	PRTN_MNGR1_EML
			<if test="prtnMngr2Dept != '' ">	
				,	PRTN_MNGR2_DEPT
				,	PRTN_MNGR2_RNK
				,	PRTN_MNGR2_NM
				,	PRTN_MNGR2_RPRSN_PH
				,	PRTN_MNGR2_PH
				,	PRTN_MNGR2_EML
			</if>	
		)
		VALUES(
					#{prtnEnrlmNum}
				,	#{prtnMngr1Dept}
				,	#{prtnMngr1Rnk}
				,	#{prtnMngr1Nm}
				,	#{prtnMngr1RprsnPh}
				,	#{prtnMngr1Ph}
				,	#{prtnMngr1Eml}
			<if test="prtnMngr2Dept != '' ">
				,	#{prtnMngr2Dept}
				,	#{prtnMngr2Rnk}
				,	#{prtnMngr2Nm}
				,	#{prtnMngr2RprsnPh}
				,	#{prtnMngr2Ph}
				,	#{prtnMngr2Eml}
			</if>	
		);		
	</insert>
	
	<!-- 협력사 정보 파일 정보 삽입. -->
	<insert id="insertPartnerFile" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		INSERT INTO TB_EEP_PRTN_FILE (
					PRTN_ENRLM_NUM
				,	ORI_FILE_NM
				,	SAVE_FILE_NM
				,	FILE_SIZE
				,	FILE_USE_YN
		)
		VALUES(
					#{prtnEnrlmNum}
				,	#{oriFileNm}
				,	#{saveFileNm}
				,	#{fileSize}
				,	#{fileUseYn}		
		)
	</insert>
	
	<!-- 모든 협력사 정보 목록 조회. -->
	<select id="selectPartnerList" resultType="com.erp.admin.business.partner.vo.ErpPartnerVo" parameterType="hashmap">
		SELECT P.PRTN_SQ
			 , C.CODE_NM
			 , P.PRTN_NM
			 , P.PRTN_RPRSN_NM
			 , P.PRTN_LOC
			 , P.PRTN_ENRLM_NUM
			 , M.PRTN_MNGR1_DEPT
			 , M.PRTN_MNGR1_RNK
			 , M.PRTN_MNGR1_NM
			 , M.PRTN_MNGR1_RPRSN_PH
			 , M.PRTN_MNGR1_EML
		FROM TB_EEP_PRTN P
		INNER JOIN TB_EST_CODE C ON C.CODE_COM_CD = P.PRTN_TYP_CD		
		JOIN TB_EEP_PRTN_MNGR M 
			USING(PRTN_ENRLM_NUM)
		<where>
			<if test="prtnTypCd != '' and prtnTypCd != null ">
				AND P.PRTN_TYP_CD = #{prtnTypCd}
			</if>		
			<if test="searchOption != '' and searchOption == 'prtnEnrlmNum'">
				AND P.PRTN_ENRLM_NUM LIKE CONCAT('%',#{search},'%')
			</if>
			<if test="searchOption != '' and searchOption == 'prtnNm'">
				AND P.PRTN_NM LIKE CONCAT('%',#{search},'%')
			</if>
		</where>
		ORDER BY P.PRTN_SQ
	</select>
	
	<!-- 협력사 파일 목록 조회 -->
	<select id="selectFileList" resultType="com.erp.admin.business.partner.vo.ErpPartnerFileVo" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		SELECT 
					PRTN_FILE_SQ
				,	ORI_FILE_NM
				,	SAVE_FILE_NM
				,	FILE_SIZE
		FROM
					TB_EEP_PRTN_FILE
		WHERE
					FILE_USE_YN = 'Y'
		AND
					PRTN_ENRLM_NUM = #{prtnEnrlmNum}
	</select>
	
	<!-- 하나(1개)의 협력사 정보 조회 -->
	<select id="selectPartner" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo" resultType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		
		SELECT
					P.PRTN_SQ
				,	C.CODE_NM	
				,	P.PRTN_TYP_CD
				,	P.PRTN_ENRLM_NUM
				,	P.PRTN_NM
				,	P.PRTN_RPRSN_NM
				,	P.PRTN_ETB_DT
				,	P.PRTN_CRPRT_NUM
				,	P.PRTN_LOC
				,	P.PRTN_BSNSCON
				,	P.PRTN_SRVC
				,	M.PRTN_MNGR_SQ
				,	M.PRTN_MNGR1_DEPT
				,	M.PRTN_MNGR1_RNK
				,	M.PRTN_MNGR1_NM
				,	M.PRTN_MNGR1_RPRSN_PH
				,	M.PRTN_MNGR1_PH
				,	M.PRTN_MNGR1_EML
				,	M.PRTN_MNGR2_DEPT
				,	M.PRTN_MNGR2_RNK
				,	M.PRTN_MNGR2_NM
				,	M.PRTN_MNGR2_RPRSN_PH
				,	M.PRTN_MNGR2_PH
				,	M.PRTN_MNGR2_EML
		FROM
				TB_EEP_PRTN	P
		INNER JOIN 
				TB_EST_CODE C ON C.CODE_COM_CD = P.PRTN_TYP_CD	
		JOIN
				TB_EEP_PRTN_MNGR M
		USING
				(PRTN_ENRLM_NUM)					
		<where>
			<if test="sq != '' and sq != null">
				AND P.PRTN_SQ = #{sq}
			</if>
		</where>		
	</select>
	
	<!-- 1개의 협력사 정보를 삭제. -->
	<delete id="deletePartner" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		DELETE FROM
			TB_EEP_PRTN
		WHERE
			PRTN_SQ = #{sq};
		DELETE FROM
			TB_EEP_PRTN_MNGR
		WHERE
			PRTN_ENRLM_NUM = #{prtnEnrlmNum};	
	</delete>
	
	<!-- 협력사정보를 삭제할 경우에 해당 협력사 파일 또한 미사용으로 변경.-->
	<update id="deleteAllPartnerFile" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		UPDATE
			TB_EEP_PRTN_FILE
		SET
			FILE_USE_YN = 'N'	
		WHERE
			PRTN_ENRLM_NUM = #{prtnEnrlmNum};
	</update>
	
	<!-- 해당 협력사의 2번째 담당자 정보를 삭제 null 로 처리. -->
	<update id="deleteSecondMngr" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		UPDATE
				TB_EEP_PRTN_MNGR
		SET
				PRTN_MNGR2_NM = NULL
			,	PRTN_MNGR2_DEPT = NULL
			,	PRTN_MNGR2_RNK = NULL
			,	PRTN_MNGR2_RPRSN_PH = NULL
			,	PRTN_MNGR2_PH = NULL
			,	PRTN_MNGR2_EML = NULL
		WHERE
				PRTN_ENRLM_NUM = #{prtnEnrlmNum};	
	</update>
	
	<!-- 협력사 정보 수정화면에서 사용자가 등록된 파일을 삭제하였을때에 해당 파일을 미사용으로 변경. -->
	<update id="deletePartnerFile" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		UPDATE
			TB_EEP_PRTN_FILE
		SET
			FILE_USE_YN = 'N'
		WHERE
			PRTN_FILE_SQ = #{prtnFileSq};	
	</update>
	
	<!-- 협력사 상세 정보를 조회하기전, 해당 협력사에 해당하는 파일이 존재하는지 확인. -->
	<select id="selectFileExist" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo" resultType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		SELECT
				COUNT(P.PRTN_SQ) AS PRTN_SQ
		FROM
				TB_EEP_PRTN P
		JOIN
				TB_EEP_PRTN_FILE F
		USING
				(PRTN_ENRLM_NUM)
		WHERE
				P.PRTN_SQ = #{sq};
	</select>
	
	<!-- 협력사 정보 입력 창에서 사업자 등록번호 중복 확인. -->
	<select id="checkDuplicate" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo" resultType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		SELECT
			COUNT(PRTN_SQ) AS COUNT
		FROM
			TB_EEP_PRTN
		WHERE
			PRTN_ENRLM_NUM = #{prtnEnrlmNum}
	</select>
	
	<update id="updatePartner" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		UPDATE
				TB_EEP_PRTN
		SET
				PRTN_TYP_CD = #{prtnTypCd}
			,	PRTN_ENRLM_NUM = #{prtnEnrlmNum}
			,	PRTN_NM = #{prtnNm}
			,	PRTN_RPRSN_NM = #{prtnRprsnNm}
		<if test="prtnTypCd == 'P00002'">
			,	PRTN_CRPRT_NUM = #{prtnCrprtNum}
		</if>	
			,	PRTN_BSNSCON = #{prtnBsnscon}
			,	PRTN_SRVC = #{prtnSrvc}
			,	PRTN_LOC = #{prtnLoc}
		WHERE
				PRTN_SQ = #{prtnSq};
				
		UPDATE
				TB_EEP_PRTN_MNGR
		SET
				PRTN_MNGR1_NM = #{prtnMngr1Nm}
			,	PRTN_MNGR1_DEPT = #{prtnMngr1Dept}
			,	PRTN_MNGR1_RNK = #{prtnMngr1Rnk}
			,	PRTN_MNGR1_RPRSN_PH = #{prtnMngr1RprsnPh}
			,	PRTN_MNGR1_PH = #{prtnMngr1Ph}
			,	PRTN_MNGR1_EML = #{prtnMngr1Eml}
		<if test="prtnMngr2Dept != '' ">
			,	PRTN_MNGR2_NM = #{prtnMngr2Nm}
			,	PRTN_MNGR2_DEPT = #{prtnMngr2Dept}
			,	PRTN_MNGR2_RNK = #{prtnMngr2Rnk}
			,	PRTN_MNGR2_RPRSN_PH = #{prtnMngr2RprsnPh}
			,	PRTN_MNGR2_PH = #{prtnMngr2Ph}
			,	PRTN_MNGR2_EML = #{prtnMngr2Eml}
		</if>	
		WHERE
				PRTN_ENRLM_NUM = #{prtnEnrlmNum};
	</update>
	<!-- 협력사 테이블의 정보와 협력사 담당자 테이블의 정보를 동시에 수정하기 때문에 협력사 담당자 테이블의 사업자 등록번호를 미리 업데이트 해주어야 한다. 마찬가지로 파일 테이블도... -->
	<!-- 그러므로 PRTN_SQ 를 가지고 수정하기전 사업자 등록번호를 가지고 온 후 변경할 사업자 등록번호로 담당자 테이블과 파일테이블 값 변경. -->
	<select id="selectPrtnEnrlmNum" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo" resultType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		SELECT
			PRTN_ENRLM_NUM
		FROM
			TB_EEP_PRTN
		WHERE
			PRTN_SQ = #{prtnSq}
	</select>
	<!-- 협력사담당자,협력사파일 테이블에서  사업자등록번호가 A 인 row 들의 사업자등록번호를 B로 업데이트. -->
	<update id="updateReferencedRow" parameterType="com.erp.admin.business.partner.vo.ErpPartnerVo">
		UPDATE
			TB_EEP_PRTN_MNGR
		SET
			PRTN_ENRLM_NUM = #{prtnEnrlmNum}
		WHERE
			PRTN_ENRLM_NUM = #{beforeUpdate};
		UPDATE
			TB_EEP_PRTN_FILE
		SET
			PRTN_ENRLM_NUM = #{prtnEnrlmNum}
		WHERE
			PRTN_ENRLM_NUM = #{beforeUpdate};	
	</update>
</mapper>